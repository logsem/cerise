<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="./">Project Page</a>
      <a href="./indexpage.html"> Index </a>
      <a href="./toc.html"> Table of Contents </a>
    </span>
</div>
    <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="main">
<h1 class="libtitle">cap_machine.exercises.subseg_buffer_closure</h1>

<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">iris.algebra</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="library">frac</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">iris.proofmode</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="library">tactics</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Logic.Eqdep_dec.html#"><span class="id" title="library">Eqdep_dec</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#"><span class="id" title="library">List</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">cap_machine</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="cap_machine.examples.malloc.html#"><span class="id" title="library">malloc</span></a> <a class="idref" href="cap_machine.examples.macros.html#"><span class="id" title="library">macros</span></a> <a class="idref" href="cap_machine.proofmode.register_tactics.html#"><span class="id" title="library">register_tactics</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">cap_machine</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="cap_machine.fundamental.html#"><span class="id" title="library">fundamental</span></a> <a class="idref" href="cap_machine.logrel.html#"><span class="id" title="library">logrel</span></a> <a class="idref" href="cap_machine.rules.html#"><span class="id" title="library">rules</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">cap_machine.proofmode</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="cap_machine.proofmode.tactics_helpers.html#"><span class="id" title="library">tactics_helpers</span></a> <a class="idref" href="cap_machine.proofmode.proofmode.html#"><span class="id" title="library">proofmode</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">cap_machine.examples</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="cap_machine.examples.template_adequacy.html#"><span class="id" title="library">template_adequacy</span></a>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">cap_machine.exercises</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="cap_machine.exercises.subseg_buffer.html#"><span class="id" title="library">subseg_buffer</span></a>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">Z_scope</span>.<br/>

<br/>
</div>

<div class="doc">
Firtly, we create a closure around our code and buffer. The capability
    pointing to the allocated buffer is stored in memory. We thus have to load
    it in the register. This part of code sets up the context, allowing to use
    the previous specification.
 
</div>
<div class="code">
<span class="id" title="keyword">Section</span> <a id="closure_program" class="idref" href="#closure_program"><span class="id" title="section">closure_program</span></a>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> {<a id="0101b9beac487b383a5ba2a8f6922788" class="idref" href="#0101b9beac487b383a5ba2a8f6922788"><span class="id" title="binder">Σ</span></a>:<span class="id" title="record">gFunctors</span>} {<a id="memg:2" class="idref" href="#memg:2"><span class="id" title="binder">memg</span></a>:<a class="idref" href="cap_machine.rules.rules_base.html#memG"><span class="id" title="class">memG</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#0101b9beac487b383a5ba2a8f6922788"><span class="id" title="variable">Σ</span></a>} {<a id="regg:3" class="idref" href="#regg:3"><span class="id" title="binder">regg</span></a>:<a class="idref" href="cap_machine.rules.rules_base.html#regG"><span class="id" title="class">regG</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#0101b9beac487b383a5ba2a8f6922788"><span class="id" title="variable">Σ</span></a>} {<a id="sealsg:4" class="idref" href="#sealsg:4"><span class="id" title="binder">sealsg</span></a>: <a class="idref" href="cap_machine.seal_store.html#sealStoreG"><span class="id" title="class">sealStoreG</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#0101b9beac487b383a5ba2a8f6922788"><span class="id" title="variable">Σ</span></a>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{<a id="MP:5" class="idref" href="#MP:5"><span class="id" title="binder">MP</span></a>: <a class="idref" href="cap_machine.machine_parameters.html#MachineParameters"><span class="id" title="class">MachineParameters</span></a>}.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> {<a id="nainv:6" class="idref" href="#nainv:6"><span class="id" title="binder">nainv</span></a>: <a class="idref" href="cap_machine.logrel.html#logrel_na_invs"><span class="id" title="class">logrel_na_invs</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b88aef838331d2609aee7b06734b3289"><span class="id" title="variable">Σ</span></a>}.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="Nclosure" class="idref" href="#Nclosure"><span class="id" title="definition">Nclosure</span></a> : <span class="id" title="definition">namespace</span> := <span class="id" title="definition">nroot</span> <span class="id" title="notation">.@</span> "closure".<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;we&nbsp;assume&nbsp;pc_b&nbsp;contains&nbsp;the&nbsp;capability&nbsp;pointing&nbsp;the&nbsp;allocated&nbsp;buffer<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;code&nbsp;load&nbsp;the&nbsp;capability&nbsp;in&nbsp;R1&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="load_code" class="idref" href="#load_code"><span class="id" title="definition">load_code</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_parameters.html#encodeInstrsW"><span class="id" title="definition">encodeInstrsW</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#Mov"><span class="id" title="constructor">Mov</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <span class="comment">(*&nbsp;r1&nbsp;=&gt;&nbsp;(RWX,&nbsp;pc_b,&nbsp;pc_e,&nbsp;a_first)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#GetB"><span class="id" title="constructor">GetB</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <span class="comment">(*&nbsp;r2&nbsp;=&gt;&nbsp;pc_b&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#GetA"><span class="id" title="constructor">GetA</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <span class="comment">(*&nbsp;r3&nbsp;=&gt;&nbsp;a_first&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#Sub"><span class="id" title="constructor">Sub</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <span class="comment">(*&nbsp;r2&nbsp;=&gt;&nbsp;(pc_b&nbsp;-&nbsp;a_first)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#Lea"><span class="id" title="constructor">Lea</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <span class="comment">(*&nbsp;r1&nbsp;=&gt;&nbsp;(RWX,&nbsp;pc_b,&nbsp;pc_e,&nbsp;pc_b)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#Load"><span class="id" title="constructor">Load</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <span class="comment">(*&nbsp;r1&nbsp;=&gt;&nbsp;(p_mem,&nbsp;b_mem,&nbsp;e_mem,&nbsp;b_mem)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="closure_code" class="idref" href="#closure_code"><span class="id" title="definition">closure_code</span></a> <a id="secret_off:7" class="idref" href="#secret_off:7"><span class="id" title="binder">secret_off</span></a> <a id="secret_val:8" class="idref" href="#secret_val:8"><span class="id" title="binder">secret_val</span></a>:=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#load_code"><span class="id" title="definition">load_code</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#bc347c51eaf667706ae54503b26d52c6"><span class="id" title="notation">++</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#bc347c51eaf667706ae54503b26d52c6"><span class="id" title="notation">(</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer.html#prog_code"><span class="id" title="definition">prog_code</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:7"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:8"><span class="id" title="variable">secret_val</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#bc347c51eaf667706ae54503b26d52c6"><span class="id" title="notation">)</span></a>.<br/>

<br/>
</div>

<div class="doc">
As we will prove that the encapsulation of the program
      in a sentry capability is safe-to-share, the memory
      propositions have to be in invariant.  We define the invariants 
</div>
<div class="code">
&nbsp;&nbsp;<span class="comment">(*&nbsp;cap_addr&nbsp;points&nbsp;to&nbsp;the&nbsp;capability&nbsp;for&nbsp;the&nbsp;buffer&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="cap_memN" class="idref" href="#cap_memN"><span class="id" title="definition">cap_memN</span></a> := <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#Nclosure"><span class="id" title="definition">Nclosure</span></a><span class="id" title="notation">.@</span>"cap_mem".<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="cap_mem_inv" class="idref" href="#cap_mem_inv"><span class="id" title="definition">cap_mem_inv</span></a> <a id="p_mem:9" class="idref" href="#p_mem:9"><span class="id" title="binder">p_mem</span></a> <a id="b_mem:10" class="idref" href="#b_mem:10"><span class="id" title="binder">b_mem</span></a> <a id="e_mem:11" class="idref" href="#e_mem:11"><span class="id" title="binder">e_mem</span></a> <a id="cap_addr:12" class="idref" href="#cap_addr:12"><span class="id" title="binder">cap_addr</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">na_inv</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#cap_memN"><span class="id" title="definition">cap_memN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#cap_addr:12"><span class="id" title="variable">cap_addr</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#e389c97555835874498bb08a394266c6"><span class="id" title="notation">↦ₐ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:9"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:10"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:11"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:10"><span class="id" title="variable">b_mem</span></a>).<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;first&nbsp;part&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;before&nbsp;the&nbsp;secret,&nbsp;is&nbsp;always&nbsp;zeroes&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="start_memN" class="idref" href="#start_memN"><span class="id" title="definition">start_memN</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#Nclosure"><span class="id" title="definition">Nclosure</span></a><span class="id" title="notation">.@</span>"start_mem").<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="start_mem_inv" class="idref" href="#start_mem_inv"><span class="id" title="definition">start_mem_inv</span></a> <a id="b_mem:13" class="idref" href="#b_mem:13"><span class="id" title="binder">b_mem</span></a> <a id="secret_off:14" class="idref" href="#secret_off:14"><span class="id" title="binder">secret_off</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="secret_addr:15" class="idref" href="#secret_addr:15"><span class="id" title="binder">secret_addr</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:13"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:14"><span class="id" title="variable">secret_off</span></a>)%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">na_inv</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#start_memN"><span class="id" title="definition">start_memN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="cap_machine.proofmode.region.html#f61454323753175334a2a2859e68823d"><span class="id" title="notation">[[</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:13"><span class="id" title="variable">b_mem</span></a><a class="idref" href="cap_machine.proofmode.region.html#f61454323753175334a2a2859e68823d"><span class="id" title="notation">,</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_addr:15"><span class="id" title="variable">secret_addr</span></a><a class="idref" href="cap_machine.proofmode.region.html#f61454323753175334a2a2859e68823d"><span class="id" title="notation">]]</span></a> <a class="idref" href="cap_machine.proofmode.region.html#f61454323753175334a2a2859e68823d"><span class="id" title="notation">↦ₐ</span></a> <a class="idref" href="cap_machine.proofmode.region.html#f61454323753175334a2a2859e68823d"><span class="id" title="notation">[[</span></a> <a class="idref" href="cap_machine.examples.addr_reg_sample.html#region_addrs_zeroes"><span class="id" title="definition">region_addrs_zeroes</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:13"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_addr:15"><span class="id" title="variable">secret_addr</span></a> <a class="idref" href="cap_machine.proofmode.region.html#f61454323753175334a2a2859e68823d"><span class="id" title="notation">]]</span></a>).<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;secret&nbsp;is&nbsp;either&nbsp;equal&nbsp;to&nbsp;0&nbsp;--&nbsp;at&nbsp;the&nbsp;initialisation&nbsp;--&nbsp;or&nbsp;equal&nbsp;to<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;42&nbsp;--&nbsp;after&nbsp;the&nbsp;secret&nbsp;was&nbsp;stored&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="secretN" class="idref" href="#secretN"><span class="id" title="definition">secretN</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#Nclosure"><span class="id" title="definition">Nclosure</span></a><span class="id" title="notation">.@</span>"secret").<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="secret_inv" class="idref" href="#secret_inv"><span class="id" title="definition">secret_inv</span></a> (<a id="b_mem:16" class="idref" href="#b_mem:16"><span class="id" title="binder">b_mem</span></a> : <a class="idref" href="cap_machine.addr_reg.html#Addr"><span class="id" title="abbreviation">Addr</span></a>) <a id="secret_off:17" class="idref" href="#secret_off:17"><span class="id" title="binder">secret_off</span></a> <a id="secret_val:18" class="idref" href="#secret_val:18"><span class="id" title="binder">secret_val</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="secret_addr:19" class="idref" href="#secret_addr:19"><span class="id" title="binder">secret_addr</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:16"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:17"><span class="id" title="variable">secret_off</span></a>)%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">na_inv</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secretN"><span class="id" title="definition">secretN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="notation">(</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_addr:19"><span class="id" title="variable">secret_addr</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#e389c97555835874498bb08a394266c6"><span class="id" title="notation">↦ₐ</span></a> <a class="idref" href="cap_machine.machine_base.html#WInt"><span class="id" title="constructor">WInt</span></a> 0<span class="id" title="notation">)</span> <span class="id" title="notation">∨</span> <span class="id" title="notation">(</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_addr:19"><span class="id" title="variable">secret_addr</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#e389c97555835874498bb08a394266c6"><span class="id" title="notation">↦ₐ</span></a> <a class="idref" href="cap_machine.machine_base.html#WInt"><span class="id" title="constructor">WInt</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:18"><span class="id" title="variable">secret_val</span></a><span class="id" title="notation">)</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;code&nbsp;instruction&nbsp;is&nbsp;stored&nbsp;in&nbsp;an&nbsp;invariant&nbsp;as&nbsp;well&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="codeN" class="idref" href="#codeN"><span class="id" title="definition">codeN</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#Nclosure"><span class="id" title="definition">Nclosure</span></a><span class="id" title="notation">.@</span>"code").<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="code_closure_inv" class="idref" href="#code_closure_inv"><span class="id" title="definition">code_closure_inv</span></a> <a id="a_prog:20" class="idref" href="#a_prog:20"><span class="id" title="binder">a_prog</span></a> <a id="secret_off:21" class="idref" href="#secret_off:21"><span class="id" title="binder">secret_off</span></a> <a id="secret_val:22" class="idref" href="#secret_val:22"><span class="id" title="binder">secret_val</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">na_inv</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#codeN"><span class="id" title="definition">codeN</span></a> (<a class="idref" href="cap_machine.proofmode.region.html#codefrag"><span class="id" title="definition">codefrag</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:20"><span class="id" title="variable">a_prog</span></a> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#closure_code"><span class="id" title="definition">closure_code</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:21"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:22"><span class="id" title="variable">secret_val</span></a>)).<br/>

<br/>
</div>

<div class="doc">
Specifications 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;specifie&nbsp;the&nbsp;closure&nbsp;program&nbsp;in&nbsp;a&nbsp;modular&nbsp;way,&nbsp;so&nbsp;we&nbsp;firstly&nbsp;specifie<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;part&nbsp;of&nbsp;the&nbsp;code&nbsp;that&nbsp;load&nbsp;the&nbsp;capability&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a id="load_spec" class="idref" href="#load_spec"><span class="id" title="lemma">load_spec</span></a> <a id="p_pc:23" class="idref" href="#p_pc:23"><span class="id" title="binder">p_pc</span></a> <a id="b_pc:24" class="idref" href="#b_pc:24"><span class="id" title="binder">b_pc</span></a> <a id="e_pc:25" class="idref" href="#e_pc:25"><span class="id" title="binder">e_pc</span></a> <a id="s_load:26" class="idref" href="#s_load:26"><span class="id" title="binder">s_load</span></a> <span class="comment">(*&nbsp;pc&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="p_mem:27" class="idref" href="#p_mem:27"><span class="id" title="binder">p_mem</span></a> <a id="b_mem:28" class="idref" href="#b_mem:28"><span class="id" title="binder">b_mem</span></a> <a id="e_mem:29" class="idref" href="#e_mem:29"><span class="id" title="binder">e_mem</span></a> <span class="comment">(*&nbsp;mem&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="w1:30" class="idref" href="#w1:30"><span class="id" title="binder">w1</span></a> <a id="w2:31" class="idref" href="#w2:31"><span class="id" title="binder">w2</span></a> <a id="w3:32" class="idref" href="#w3:32"><span class="id" title="binder">w3</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="EN:33" class="idref" href="#EN:33"><span class="id" title="binder">EN</span></a> <a id="e1c460f07e68babf0246822351fc594f" class="idref" href="#e1c460f07e68babf0246822351fc594f"><span class="id" title="binder">φ</span></a> :<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="e_load:35" class="idref" href="#e_load:35"><span class="id" title="binder">e_load</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_load:26"><span class="id" title="variable">s_load</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <span class="id" title="abbreviation">length</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#load_code"><span class="id" title="definition">load_code</span></a>)%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#ExecPCPerm"><span class="id" title="definition">ExecPCPerm</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_pc:23"><span class="id" title="variable">p_pc</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="machine_utils.finz_base.html#SubBounds"><span class="id" title="definition">SubBounds</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:24"><span class="id" title="variable">b_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_pc:25"><span class="id" title="variable">e_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_load:26"><span class="id" title="variable">s_load</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_load:35"><span class="id" title="variable">e_load</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#writeAllowed"><span class="id" title="definition">writeAllowed</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:27"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">↑</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#cap_memN"><span class="id" title="definition">cap_memN</span></a> <span class="id" title="notation">⊆</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:33"><span class="id" title="variable">EN</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">⊢</span> ( <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#cap_mem_inv"><span class="id" title="definition">cap_mem_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:27"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:28"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:29"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:24"><span class="id" title="variable">b_pc</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_pc:23"><span class="id" title="variable">p_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:24"><span class="id" title="variable">b_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_pc:25"><span class="id" title="variable">e_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_load:26"><span class="id" title="variable">s_load</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w1:30"><span class="id" title="variable">w1</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w2:31"><span class="id" title="variable">w2</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w3:32"><span class="id" title="variable">w3</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.proofmode.region.html#codefrag"><span class="id" title="definition">codefrag</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_load:26"><span class="id" title="variable">s_load</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#load_code"><span class="id" title="definition">load_code</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="definition">na_own</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:33"><span class="id" title="variable">EN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="notation">▷</span> <span class="id" title="notation">(</span> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_pc:23"><span class="id" title="variable">p_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:24"><span class="id" title="variable">b_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_pc:25"><span class="id" title="variable">e_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_load:35"><span class="id" title="variable">e_load</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:27"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:28"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:29"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:28"><span class="id" title="variable">b_mem</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="notation">(</span><span class="id" title="notation">∃</span> <a id="w2:36" class="idref" href="#w2:36"><span class="id" title="binder">w2</span></a><span class="id" title="notation">,</span> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w2:36"><span class="id" title="variable">w2</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="notation">(</span><span class="id" title="notation">∃</span> <a id="w3:37" class="idref" href="#w3:37"><span class="id" title="binder">w3</span></a><span class="id" title="notation">,</span> <a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w3:37"><span class="id" title="variable">w3</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.proofmode.region.html#codefrag"><span class="id" title="definition">codefrag</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_load:26"><span class="id" title="variable">s_load</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#load_code"><span class="id" title="definition">load_code</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="definition">na_own</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:33"><span class="id" title="variable">EN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">-∗</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">WP</span> <a class="idref" href="cap_machine.cap_lang.html#Seq"><span class="id" title="constructor">Seq</span></a> (<a class="idref" href="cap_machine.cap_lang.html#Instr"><span class="id" title="constructor">Instr</span></a> <a class="idref" href="cap_machine.cap_lang.html#Executable"><span class="id" title="constructor">Executable</span></a>) <span class="id" title="notation">{{</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e1c460f07e68babf0246822351fc594f"><span class="id" title="variable">φ</span></a> <span class="id" title="notation">}}</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">-∗</span> <span class="id" title="notation">WP</span> <a class="idref" href="cap_machine.cap_lang.html#Seq"><span class="id" title="constructor">Seq</span></a> (<a class="idref" href="cap_machine.cap_lang.html#Instr"><span class="id" title="constructor">Instr</span></a> <a class="idref" href="cap_machine.cap_lang.html#Executable"><span class="id" title="constructor">Executable</span></a>) <span class="id" title="notation">{{</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e1c460f07e68babf0246822351fc594f"><span class="id" title="variable">φ</span></a> <span class="id" title="notation">}}</span>)%<span class="id" title="var">I</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">end_load</span> ; <span class="id" title="tactic">subst</span> <span class="id" title="var">end_load</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> (<span class="id" title="var">Hpc_perm</span> <span class="id" title="var">Hpc_bounds</span> <span class="id" title="var">Hp_mem</span> <span class="id" title="var">Hnainv_cap</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"(#Hinv_cap &amp; HPC &amp; Hr1 &amp; Hr2 &amp; Hr3 &amp; Hprog &amp; Hna &amp; Post)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">codefrag_facts</span> "Hprog".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iMod</span> <span class="id" title="notation">(</span><span class="id" title="lemma">na_inv_acc</span> <span class="id" title="notation">with</span> "Hinv_cap Hna"<span class="id" title="notation">)</span> <span class="id" title="keyword">as</span> "(&gt;Hcap&amp; Hna&amp; Hinv_close)" ; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iGo</span> "Hprog".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">transitivity</span> (<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">b_pc</span>); <span class="id" title="tactic">eauto</span>. <span class="id" title="var">solve_addr</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iGo</span> "Hprog".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iMod</span> <span class="id" title="notation">(</span>"Hinv_close" <span class="id" title="notation">with</span> "[Hcap Hna]"<span class="id" title="notation">)</span> <span class="id" title="keyword">as</span> "Hna" ; <span class="id" title="var">iFrame</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iApply</span> "Post". <span class="id" title="var">iFrame</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iSplitL</span> "Hr2" ; <span class="id" title="var">iExists</span> <span class="id" title="var">_</span> ; <span class="id" title="var">iFrame</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">Unshelve</span>. <span class="id" title="var">Fail</span> <span class="id" title="tactic">idtac</span>. <span class="id" title="var">Admitted</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;specifie&nbsp;the&nbsp;part&nbsp;of&nbsp;the&nbsp;program&nbsp;that&nbsp;store&nbsp;the&nbsp;secret,&nbsp;using&nbsp;the<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;invariant.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a id="prog_closure_spec" class="idref" href="#prog_closure_spec"><span class="id" title="lemma">prog_closure_spec</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="wadv:38" class="idref" href="#wadv:38"><span class="id" title="binder">wadv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="p_pc:39" class="idref" href="#p_pc:39"><span class="id" title="binder">p_pc</span></a> <a id="b_pc:40" class="idref" href="#b_pc:40"><span class="id" title="binder">b_pc</span></a> <a id="e_pc:41" class="idref" href="#e_pc:41"><span class="id" title="binder">e_pc</span></a> <a id="a_prog:42" class="idref" href="#a_prog:42"><span class="id" title="binder">a_prog</span></a> <span class="comment">(*&nbsp;pc&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="p_mem:43" class="idref" href="#p_mem:43"><span class="id" title="binder">p_mem</span></a> <a id="b_mem:44" class="idref" href="#b_mem:44"><span class="id" title="binder">b_mem</span></a> <a id="e_mem:45" class="idref" href="#e_mem:45"><span class="id" title="binder">e_mem</span></a> <span class="comment">(*&nbsp;mem&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="w2:46" class="idref" href="#w2:46"><span class="id" title="binder">w2</span></a> <a id="w3:47" class="idref" href="#w3:47"><span class="id" title="binder">w3</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="secret_off:48" class="idref" href="#secret_off:48"><span class="id" title="binder">secret_off</span></a> <a id="secret_val:49" class="idref" href="#secret_val:49"><span class="id" title="binder">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="EN:50" class="idref" href="#EN:50"><span class="id" title="binder">EN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="df3b3e3792d9f92ed8047d8c01cbf6a0" class="idref" href="#df3b3e3792d9f92ed8047d8c01cbf6a0"><span class="id" title="binder">φ</span></a> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="secret:52" class="idref" href="#secret:52"><span class="id" title="binder">secret</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:44"><span class="id" title="variable">b_mem</span></a><a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:48"><span class="id" title="variable">secret_off</span></a>)%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="len_p:53" class="idref" href="#len_p:53"><span class="id" title="binder">len_p</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:42"><span class="id" title="variable">a_prog</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <span class="id" title="abbreviation">length</span> (<a class="idref" href="cap_machine.exercises.subseg_buffer.html#prog_code"><span class="id" title="definition">prog_code</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:48"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:49"><span class="id" title="variable">secret_val</span></a>))%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#ExecPCPerm"><span class="id" title="definition">ExecPCPerm</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_pc:39"><span class="id" title="variable">p_pc</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="machine_utils.finz_base.html#SubBounds"><span class="id" title="definition">SubBounds</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:40"><span class="id" title="variable">b_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_pc:41"><span class="id" title="variable">e_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:42"><span class="id" title="variable">a_prog</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#len_p:53"><span class="id" title="variable">len_p</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:44"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.addr_reg.html#ecb49afb136c57143f8ddd1e3e9a03fe"><span class="id" title="notation">&lt;=</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret:52"><span class="id" title="variable">secret</span></a> <a class="idref" href="cap_machine.addr_reg.html#ecb49afb136c57143f8ddd1e3e9a03fe"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:45"><span class="id" title="variable">e_mem</span></a>)%<span class="id" title="var">a</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#writeAllowed"><span class="id" title="definition">writeAllowed</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:43"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">↑</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secretN"><span class="id" title="definition">secretN</span></a> <span class="id" title="notation">⊆</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:50"><span class="id" title="variable">EN</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">⊢</span> ( <span class="comment">(*&nbsp;PC&nbsp;points&nbsp;to&nbsp;prog_code*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">(</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_inv"><span class="id" title="definition">secret_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:44"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:48"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:49"><span class="id" title="variable">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_pc:39"><span class="id" title="variable">p_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:40"><span class="id" title="variable">b_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_pc:41"><span class="id" title="variable">e_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:42"><span class="id" title="variable">a_prog</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:43"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:44"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:45"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:44"><span class="id" title="variable">b_mem</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w2:46"><span class="id" title="variable">w2</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w3:47"><span class="id" title="variable">w3</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#wadv:38"><span class="id" title="variable">wadv</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.proofmode.region.html#codefrag"><span class="id" title="definition">codefrag</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:42"><span class="id" title="variable">a_prog</span></a> (<a class="idref" href="cap_machine.exercises.subseg_buffer.html#prog_code"><span class="id" title="definition">prog_code</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:48"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:49"><span class="id" title="variable">secret_val</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="definition">na_own</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:50"><span class="id" title="variable">EN</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="notation">▷</span> ( <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#updatePcPerm"><span class="id" title="definition">updatePcPerm</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#wadv:38"><span class="id" title="variable">wadv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:43"><span class="id" title="variable">p_mem</span></a> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:44"><span class="id" title="variable">b_mem</span></a><a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+(</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:48"><span class="id" title="variable">secret_off</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">)</span></a>)%<span class="id" title="var">a</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:45"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret:52"><span class="id" title="variable">secret</span></a>%<span class="id" title="var">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WInt"><span class="id" title="constructor">WInt</span></a> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:44"><span class="id" title="variable">b_mem</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+(</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:48"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">)</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WInt"><span class="id" title="constructor">WInt</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:45"><span class="id" title="variable">e_mem</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#wadv:38"><span class="id" title="variable">wadv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.proofmode.region.html#codefrag"><span class="id" title="definition">codefrag</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:42"><span class="id" title="variable">a_prog</span></a> (<a class="idref" href="cap_machine.exercises.subseg_buffer.html#prog_code"><span class="id" title="definition">prog_code</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:48"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:49"><span class="id" title="variable">secret_val</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="definition">na_own</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:50"><span class="id" title="variable">EN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">-∗</span> <span class="id" title="notation">WP</span> <a class="idref" href="cap_machine.cap_lang.html#Seq"><span class="id" title="constructor">Seq</span></a> (<a class="idref" href="cap_machine.cap_lang.html#Instr"><span class="id" title="constructor">Instr</span></a> <a class="idref" href="cap_machine.cap_lang.html#Executable"><span class="id" title="constructor">Executable</span></a>) <span class="id" title="notation">{{</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#df3b3e3792d9f92ed8047d8c01cbf6a0"><span class="id" title="variable">φ</span></a> <span class="id" title="notation">}}</span>)%<span class="id" title="var">I</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">)</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">-∗</span> <span class="id" title="notation">WP</span> <a class="idref" href="cap_machine.cap_lang.html#Seq"><span class="id" title="constructor">Seq</span></a> (<a class="idref" href="cap_machine.cap_lang.html#Instr"><span class="id" title="constructor">Instr</span></a> <a class="idref" href="cap_machine.cap_lang.html#Executable"><span class="id" title="constructor">Executable</span></a>) <span class="id" title="notation">{{</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#df3b3e3792d9f92ed8047d8c01cbf6a0"><span class="id" title="variable">φ</span></a> <span class="id" title="notation">}}</span>)%<span class="id" title="var">I</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span> * <span class="id" title="var">Hpc_perm</span> <span class="id" title="var">Hpc_bounds</span> <span class="id" title="var">Hlen_mem</span> <span class="id" title="var">Hp_mem</span> <span class="id" title="var">Hnainv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> "(#Hinv_secret &amp; HPC&amp; Hr1&amp; Hr2&amp; Hr3&amp; Hr30&amp; Hprog&amp; Hna &amp; Post)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span> <span class="id" title="var">secret</span> <span class="id" title="var">len_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">codefrag_facts</span> "Hprog".<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iMod</span> <span class="id" title="notation">(</span><span class="id" title="lemma">na_inv_acc</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <span class="id" title="notation">with</span> "Hinv_secret Hna"<span class="id" title="notation">)</span> <span class="id" title="keyword">as</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"(&gt;Hsecret &amp; Hna &amp; Hclose_secret)" ; <span class="id" title="tactic">auto</span>. <span class="comment">(*&nbsp;inclusion&nbsp;namespace&nbsp;*)</span><br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> /<a class="idref" href="cap_machine.exercises.subseg_buffer.html#prog_code"><span class="id" title="definition">prog_code</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">Hp_mem'</span>: <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#63a68285c81db8f9bc456233bb9ed181"><span class="id" title="notation">~</span></a> <span class="id" title="var">p_mem</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="cap_machine.machine_base.html#E"><span class="id" title="constructor">E</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">by</span> (<span class="id" title="tactic">intros</span> -&gt; ; <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> <span class="id" title="var">Hp_mem</span> ; <span class="id" title="tactic">discriminate</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Lea&nbsp;r_t1&nbsp;secret_off&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iInstr</span> "Hprog".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">transitivity</span> (<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<span class="id" title="var">b_mem</span> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a><span class="id" title="var">secret_off</span>)%<span class="id" title="var">a</span>) ; <span class="id" title="tactic">auto</span>. <span class="id" title="var">solve_addr</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Store&nbsp;r_t1&nbsp;42&nbsp;,&nbsp;where&nbsp;r_t1&nbsp;=&nbsp;(RWX,&nbsp;b,&nbsp;e,&nbsp;secret)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Regarding&nbsp;the&nbsp;invariant,&nbsp;the&nbsp;secret&nbsp;can&nbsp;be&nbsp;either&nbsp;0&nbsp;or&nbsp;42&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iDestruct</span> "Hsecret" <span class="id" title="keyword">as</span> "[Hsecret | Hsecret]".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="var">iInstr</span> "Hprog" ; [<span class="id" title="var">solve_addr</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;getB&nbsp;getE&nbsp;add&nbsp;subseg&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="var">iGo</span> "Hprog"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> <span class="id" title="tactic">transitivity</span> (<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> (<span class="id" title="var">b_mem</span> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+(</span></a><span class="id" title="var">secret_off</span><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">)</span></a>)%<span class="id" title="var">a</span>) ; <span class="id" title="tactic">auto</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> <span class="id" title="var">solve_addr</span> .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;jmp&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="var">iInstr</span> "Hprog".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;halts&nbsp;in&nbsp;the&nbsp;adversary&nbsp;code&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="var">iMod</span> <span class="id" title="notation">(</span>"Hclose_secret" <span class="id" title="notation">with</span> "[Hsecret $Hna]"<span class="id" title="notation">)</span> <span class="id" title="keyword">as</span> "Hna"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; [<span class="id" title="var">iNext</span> ; <span class="id" title="var">iRight</span> ; <span class="id" title="var">iFrame</span> |].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="var">iApply</span> "Post".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="var">iFrame</span> ; <span class="id" title="var">iFrame</span> "#".<br/>
&nbsp;&nbsp;<span class="id" title="var">Unshelve</span>. <span class="id" title="var">Fail</span> <span class="id" title="tactic">idtac</span>. <span class="id" title="var">Admitted</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Specification&nbsp;of&nbsp;the&nbsp;full&nbsp;program,&nbsp;stops&nbsp;after&nbsp;the&nbsp;jump&nbsp;to&nbsp;the&nbsp;adversary&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a id="closure_spec" class="idref" href="#closure_spec"><span class="id" title="lemma">closure_spec</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="pc_p:54" class="idref" href="#pc_p:54"><span class="id" title="binder">pc_p</span></a> <a id="pc_b:55" class="idref" href="#pc_b:55"><span class="id" title="binder">pc_b</span></a> <a id="pc_e:56" class="idref" href="#pc_e:56"><span class="id" title="binder">pc_e</span></a> <a id="s_closure:57" class="idref" href="#s_closure:57"><span class="id" title="binder">s_closure</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="p_mem:58" class="idref" href="#p_mem:58"><span class="id" title="binder">p_mem</span></a> <a id="b_mem:59" class="idref" href="#b_mem:59"><span class="id" title="binder">b_mem</span></a> <a id="e_mem:60" class="idref" href="#e_mem:60"><span class="id" title="binder">e_mem</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="w1:61" class="idref" href="#w1:61"><span class="id" title="binder">w1</span></a> <a id="w2:62" class="idref" href="#w2:62"><span class="id" title="binder">w2</span></a> <a id="w3:63" class="idref" href="#w3:63"><span class="id" title="binder">w3</span></a> <a id="w_adv:64" class="idref" href="#w_adv:64"><span class="id" title="binder">w_adv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="secret_off:65" class="idref" href="#secret_off:65"><span class="id" title="binder">secret_off</span></a> <a id="secret_val:66" class="idref" href="#secret_val:66"><span class="id" title="binder">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="EN:67" class="idref" href="#EN:67"><span class="id" title="binder">EN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="6e868649af7839bd225e1fbe6e95120a" class="idref" href="#6e868649af7839bd225e1fbe6e95120a"><span class="id" title="binder">φ</span></a> :<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="secret:69" class="idref" href="#secret:69"><span class="id" title="binder">secret</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:59"><span class="id" title="variable">b_mem</span></a><a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:65"><span class="id" title="variable">secret_off</span></a>)%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="e_closure:70" class="idref" href="#e_closure:70"><span class="id" title="binder">e_closure</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_closure:57"><span class="id" title="variable">s_closure</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <span class="id" title="abbreviation">length</span> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#closure_code"><span class="id" title="definition">closure_code</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:65"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:66"><span class="id" title="variable">secret_val</span></a>))%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#ExecPCPerm"><span class="id" title="definition">ExecPCPerm</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_p:54"><span class="id" title="variable">pc_p</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="machine_utils.finz_base.html#SubBounds"><span class="id" title="definition">SubBounds</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_b:55"><span class="id" title="variable">pc_b</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_e:56"><span class="id" title="variable">pc_e</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_closure:57"><span class="id" title="variable">s_closure</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_closure:70"><span class="id" title="variable">e_closure</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:59"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.addr_reg.html#ecb49afb136c57143f8ddd1e3e9a03fe"><span class="id" title="notation">&lt;=</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret:69"><span class="id" title="variable">secret</span></a> <a class="idref" href="cap_machine.addr_reg.html#ecb49afb136c57143f8ddd1e3e9a03fe"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:60"><span class="id" title="variable">e_mem</span></a>)%<span class="id" title="var">a</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#writeAllowed"><span class="id" title="definition">writeAllowed</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:58"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">↑</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secretN"><span class="id" title="definition">secretN</span></a> <span class="id" title="notation">⊆</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:67"><span class="id" title="variable">EN</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">↑</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#codeN"><span class="id" title="definition">codeN</span></a> <span class="id" title="notation">⊆</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:67"><span class="id" title="variable">EN</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">↑</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#cap_memN"><span class="id" title="definition">cap_memN</span></a> <span class="id" title="notation">⊆</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:67"><span class="id" title="variable">EN</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">⊢</span> ( <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_inv"><span class="id" title="definition">secret_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:59"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:65"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:66"><span class="id" title="variable">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#code_closure_inv"><span class="id" title="definition">code_closure_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_closure:57"><span class="id" title="variable">s_closure</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:65"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:66"><span class="id" title="variable">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#cap_mem_inv"><span class="id" title="definition">cap_mem_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:58"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:59"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:60"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_b:55"><span class="id" title="variable">pc_b</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_p:54"><span class="id" title="variable">pc_p</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_b:55"><span class="id" title="variable">pc_b</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_e:56"><span class="id" title="variable">pc_e</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_closure:57"><span class="id" title="variable">s_closure</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w1:61"><span class="id" title="variable">w1</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w2:62"><span class="id" title="variable">w2</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w3:63"><span class="id" title="variable">w3</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w_adv:64"><span class="id" title="variable">w_adv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="definition">na_own</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:67"><span class="id" title="variable">EN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="notation">▷</span> <span class="id" title="notation">(</span> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#updatePcPerm"><span class="id" title="definition">updatePcPerm</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w_adv:64"><span class="id" title="variable">w_adv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:58"><span class="id" title="variable">p_mem</span></a> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:59"><span class="id" title="variable">b_mem</span></a><a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+(</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:65"><span class="id" title="variable">secret_off</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">)</span></a>)%<span class="id" title="var">a</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:60"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret:69"><span class="id" title="variable">secret</span></a>%<span class="id" title="var">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WInt"><span class="id" title="constructor">WInt</span></a> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:59"><span class="id" title="variable">b_mem</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+(</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:65"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">)</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WInt"><span class="id" title="constructor">WInt</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:60"><span class="id" title="variable">e_mem</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w_adv:64"><span class="id" title="variable">w_adv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="definition">na_own</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#EN:67"><span class="id" title="variable">EN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">-∗</span> <span class="id" title="notation">WP</span> <a class="idref" href="cap_machine.cap_lang.html#Seq"><span class="id" title="constructor">Seq</span></a> (<a class="idref" href="cap_machine.cap_lang.html#Instr"><span class="id" title="constructor">Instr</span></a> <a class="idref" href="cap_machine.cap_lang.html#Executable"><span class="id" title="constructor">Executable</span></a>) <span class="id" title="notation">{{</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#6e868649af7839bd225e1fbe6e95120a"><span class="id" title="variable">φ</span></a> <span class="id" title="notation">}}</span><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">-∗</span> <span class="id" title="notation">WP</span> <a class="idref" href="cap_machine.cap_lang.html#Seq"><span class="id" title="constructor">Seq</span></a> (<a class="idref" href="cap_machine.cap_lang.html#Instr"><span class="id" title="constructor">Instr</span></a> <a class="idref" href="cap_machine.cap_lang.html#Executable"><span class="id" title="constructor">Executable</span></a>) <span class="id" title="notation">{{</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#6e868649af7839bd225e1fbe6e95120a"><span class="id" title="variable">φ</span></a> <span class="id" title="notation">}}</span>)%<span class="id" title="var">I</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">secret</span> <span class="id" title="var">e_closure</span> ; <span class="id" title="tactic">subst</span> <span class="id" title="var">secret</span> <span class="id" title="var">e_closure</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> (<span class="id" title="var">Hpc_perm</span> <span class="id" title="var">Hpc_bounds</span> <span class="id" title="var">Hvsecret</span> <span class="id" title="var">Hp_mem</span> <span class="id" title="var">Hnainv_secret</span> <span class="id" title="var">Hnainv_code</span> <span class="id" title="var">Hnainv_cap</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"(#Hinv_secret &amp; #Hinv_code &amp; #Hinv_cap &amp; HPC &amp; Hr1 &amp; Hr2 &amp; Hr3 &amp; Hr30 &amp; Hna &amp; Post)".<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> /<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#code_closure_inv"><span class="id" title="definition">code_closure_inv</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iMod</span> <span class="id" title="notation">(</span><span class="id" title="lemma">na_inv_acc</span> <span class="id" title="notation">with</span> "Hinv_code Hna"<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> "(&gt;Hprog &amp; Hna &amp; Hprog_close)"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> /<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#closure_code"><span class="id" title="definition">closure_code</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">focus_block_0</span> "Hprog" <span class="id" title="keyword">as</span> "Hload" "Hcont".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iApply</span> <span class="id" title="notation">(</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#load_spec"><span class="id" title="axiom">load_spec</span></a> <span class="id" title="notation">with</span> "[-]"<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> (<span class="id" title="var">iFrame</span> ; <span class="id" title="var">iFrame</span> "#")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">eauto</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> <span class="id" title="var">solve_ndisj</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iNext</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> "(HPC &amp; Hr1 &amp; Hr2 &amp; Hr3 &amp; Hload &amp; Hna)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">w2</span> <span class="id" title="var">w3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iDestruct</span> "Hr2" <span class="id" title="keyword">as</span> (<span class="id" title="var">w2</span>) "Hr2"; <span class="id" title="var">iDestruct</span> "Hr3" <span class="id" title="keyword">as</span> (<span class="id" title="var">w3</span>) "Hr3".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">unfocus_block</span> "Hload" "Hcont" <span class="id" title="keyword">as</span> "Hprog" .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">focus_block</span> 1%<span class="id" title="var">nat</span> "Hprog" <span class="id" title="keyword">as</span> <span class="id" title="var">a_mid</span> <span class="id" title="var">Ha_mid</span> "Hprog" "Hcont".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iApply</span> <span class="id" title="notation">(</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#prog_closure_spec"><span class="id" title="axiom">prog_closure_spec</span></a> <span class="id" title="notation">with</span> "[-]"<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> (<span class="id" title="var">iFrame</span>; <span class="id" title="var">iFrame</span> "#")<br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">eauto</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> <span class="id" title="var">solve_ndisj</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iNext</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> "(HPC &amp; Hr1 &amp; Hr2 &amp; Hr3 &amp; Hr30 &amp; Hprog &amp;Hna)".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">unfocus_block</span> "Hprog" "Hcont" <span class="id" title="keyword">as</span> "Hprog" .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iMod</span> <span class="id" title="notation">(</span>"Hprog_close" <span class="id" title="notation">with</span> "[$Hprog $Hna]"<span class="id" title="notation">)</span> <span class="id" title="keyword">as</span> "Hna".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iApply</span> "Post" ; <span class="id" title="var">iFrame</span> ; <span class="id" title="var">iFrame</span> "#".<br/>
&nbsp;&nbsp;<span class="id" title="var">Unshelve</span>. <span class="id" title="var">Fail</span> <span class="id" title="tactic">idtac</span>. <span class="id" title="var">Admitted</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Invariant&nbsp;on&nbsp;the&nbsp;shared&nbsp;part&nbsp;of&nbsp;the&nbsp;buffer&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="end_memN" class="idref" href="#end_memN"><span class="id" title="definition">end_memN</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#Nclosure"><span class="id" title="definition">Nclosure</span></a><span class="id" title="notation">.@</span>"end_mem").<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a id="end_mem_inv" class="idref" href="#end_mem_inv"><span class="id" title="definition">end_mem_inv</span></a> <a id="b_mem:71" class="idref" href="#b_mem:71"><span class="id" title="binder">b_mem</span></a> <a id="e_mem:72" class="idref" href="#e_mem:72"><span class="id" title="binder">e_mem</span></a> <a id="secret_off:73" class="idref" href="#secret_off:73"><span class="id" title="binder">secret_off</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="n_secret_addr:74" class="idref" href="#n_secret_addr:74"><span class="id" title="binder">n_secret_addr</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:71"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">(</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:73"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a> 1<a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">)</span></a>)%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">na_inv</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#end_memN"><span class="id" title="definition">end_memN</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="notation">[∗</span> <span class="id" title="notation">list</span><span class="id" title="notation">]</span> <a id="a:75" class="idref" href="#a:75"><span class="id" title="binder"><span id="a:76" class="id">a</span></span></a> <span class="id" title="notation">∈</span> <a class="idref" href="machine_utils.finz_interval.html#finz.seq_between"><span class="id" title="definition">finz.seq_between</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#n_secret_addr:74"><span class="id" title="variable">n_secret_addr</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:72"><span class="id" title="variable">e_mem</span></a><span class="id" title="notation">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∃</span> <a id="P:77" class="idref" href="#P:77"><span class="id" title="binder">P</span></a><span class="id" title="notation">,</span> <span class="id" title="definition">inv</span> (<a class="idref" href="cap_machine.logrel.html#logN"><span class="id" title="definition">logN</span></a> <span class="id" title="notation">.@</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a:75"><span class="id" title="variable">a</span></a>) (<a class="idref" href="cap_machine.logrel.html#interp_ref_inv"><span class="id" title="definition">interp_ref_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a:75"><span class="id" title="variable">a</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#P:77"><span class="id" title="variable">P</span></a>) <span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.logrel.html#read_cond"><span class="id" title="definition">read_cond</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#P:77"><span class="id" title="variable">P</span></a> <a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.logrel.html#write_cond"><span class="id" title="definition">write_cond</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#P:77"><span class="id" title="variable">P</span></a> <a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a>)%<span class="id" title="var">I</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Assuming&nbsp;that&nbsp;the&nbsp;word&nbsp;of&nbsp;the&nbsp;adversary&nbsp;is&nbsp;safe&nbsp;to&nbsp;share,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;machine&nbsp;executes&nbsp;safely&nbsp;and&nbsp;completely.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a id="closure_full_run_spec" class="idref" href="#closure_full_run_spec"><span class="id" title="lemma">closure_full_run_spec</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="pc_p:78" class="idref" href="#pc_p:78"><span class="id" title="binder">pc_p</span></a> <a id="pc_b:79" class="idref" href="#pc_b:79"><span class="id" title="binder">pc_b</span></a> <a id="pc_e:80" class="idref" href="#pc_e:80"><span class="id" title="binder">pc_e</span></a> <a id="s_closure:81" class="idref" href="#s_closure:81"><span class="id" title="binder">s_closure</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="p_mem:82" class="idref" href="#p_mem:82"><span class="id" title="binder">p_mem</span></a> <a id="b_mem:83" class="idref" href="#b_mem:83"><span class="id" title="binder">b_mem</span></a> <a id="e_mem:84" class="idref" href="#e_mem:84"><span class="id" title="binder">e_mem</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="secret_off:85" class="idref" href="#secret_off:85"><span class="id" title="binder">secret_off</span></a> <a id="secret_val:86" class="idref" href="#secret_val:86"><span class="id" title="binder">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="w_adv:87" class="idref" href="#w_adv:87"><span class="id" title="binder">w_adv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="rmap:88" class="idref" href="#rmap:88"><span class="id" title="binder">rmap</span></a> :<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="secret:89" class="idref" href="#secret:89"><span class="id" title="binder">secret</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:83"><span class="id" title="variable">b_mem</span></a><a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:85"><span class="id" title="variable">secret_off</span></a>)%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="e_closure:90" class="idref" href="#e_closure:90"><span class="id" title="binder">e_closure</span></a> := (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_closure:81"><span class="id" title="variable">s_closure</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <span class="id" title="abbreviation">length</span> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#closure_code"><span class="id" title="definition">closure_code</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:85"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:86"><span class="id" title="variable">secret_val</span></a>))%<span class="id" title="var">a</span> <span class="id" title="tactic">in</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#ExecPCPerm"><span class="id" title="definition">ExecPCPerm</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_p:78"><span class="id" title="variable">pc_p</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="machine_utils.finz_base.html#SubBounds"><span class="id" title="definition">SubBounds</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_b:79"><span class="id" title="variable">pc_b</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_e:80"><span class="id" title="variable">pc_e</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_closure:81"><span class="id" title="variable">s_closure</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_closure:90"><span class="id" title="variable">e_closure</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:83"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.addr_reg.html#ecb49afb136c57143f8ddd1e3e9a03fe"><span class="id" title="notation">&lt;=</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret:89"><span class="id" title="variable">secret</span></a> <a class="idref" href="cap_machine.addr_reg.html#ecb49afb136c57143f8ddd1e3e9a03fe"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:84"><span class="id" title="variable">e_mem</span></a>)%<span class="id" title="var">a</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#writeAllowed"><span class="id" title="definition">writeAllowed</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:82"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">dom</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#rmap:88"><span class="id" title="variable">rmap</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="cap_machine.addr_reg.html#all_registers_s"><span class="id" title="definition">all_registers_s</span></a> <span class="id" title="notation">∖</span> <span class="id" title="notation">{[</span> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <span class="id" title="notation">;</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a> <span class="id" title="notation">]}</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Unicode.Utf8_core.html#c41c566ddac4c1298b9e7dd2bae1c794"><span class="id" title="notation">→</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">⊢</span> ( <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#code_closure_inv"><span class="id" title="definition">code_closure_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_closure:81"><span class="id" title="variable">s_closure</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:85"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:86"><span class="id" title="variable">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#end_mem_inv"><span class="id" title="definition">end_mem_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:83"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:84"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:85"><span class="id" title="variable">secret_off</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_inv"><span class="id" title="definition">secret_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:83"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:85"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:86"><span class="id" title="variable">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#cap_mem_inv"><span class="id" title="definition">cap_mem_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:82"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:83"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:84"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_b:79"><span class="id" title="variable">pc_b</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_p:78"><span class="id" title="variable">pc_p</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_b:79"><span class="id" title="variable">pc_b</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#pc_e:80"><span class="id" title="variable">pc_e</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#s_closure:81"><span class="id" title="variable">s_closure</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w_adv:87"><span class="id" title="variable">w_adv</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="notation">(</span><span class="id" title="notation">[∗</span> <span class="id" title="notation">map</span><span class="id" title="notation">]</span> <a id="r:91" class="idref" href="#r:91"><span class="id" title="binder"><span id="r:92" class="id">r</span></span></a><span class="id" title="notation">↦</span><a id="w:93" class="idref" href="#w:93"><span class="id" title="binder"><span id="w:94" class="id">w</span></span></a> <span class="id" title="notation">∈</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#rmap:88"><span class="id" title="variable">rmap</span></a><span class="id" title="notation">,</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#r:91"><span class="id" title="variable">r</span></a> <a class="idref" href="cap_machine.rules.rules_base.html#db884c99aed36a9ddaddcd7edc424755"><span class="id" title="notation">↦ᵣ</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w:93"><span class="id" title="variable">w</span></a> <span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w:93"><span class="id" title="variable">w</span></a><span class="id" title="notation">)</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <span class="id" title="definition">na_own</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <span class="id" title="notation">⊤</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#w_adv:87"><span class="id" title="variable">w_adv</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">-∗</span> <span class="id" title="notation">WP</span> <a class="idref" href="cap_machine.cap_lang.html#Seq"><span class="id" title="constructor">Seq</span></a> (<a class="idref" href="cap_machine.cap_lang.html#Instr"><span class="id" title="constructor">Instr</span></a> <a class="idref" href="cap_machine.cap_lang.html#Executable"><span class="id" title="constructor">Executable</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">{{</span> <a id="v:95" class="idref" href="#v:95"><span class="id" title="binder">v</span></a><span class="id" title="notation">,</span> <span class="id" title="notation">⌜</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#v:95"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="cap_machine.cap_lang.html#HaltedV"><span class="id" title="constructor">HaltedV</span></a><span class="id" title="notation">⌝</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">→</span> <span class="id" title="notation">∃</span> <a id="r:96" class="idref" href="#r:96"><span class="id" title="binder">r</span></a> : <a class="idref" href="cap_machine.machine_base.html#Reg"><span class="id" title="definition">Reg</span></a><span class="id" title="notation">,</span> <a class="idref" href="cap_machine.logrel.html#full_map"><span class="id" title="definition">full_map</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#r:96"><span class="id" title="variable">r</span></a> <span class="id" title="notation">∧</span> <a class="idref" href="cap_machine.logrel.html#registers_mapsto"><span class="id" title="definition">registers_mapsto</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#r:96"><span class="id" title="variable">r</span></a> <span class="id" title="notation">∗</span> <span class="id" title="definition">na_own</span> <a class="idref" href="cap_machine.logrel.html#logrel_nais"><span class="id" title="method">logrel_nais</span></a> <span class="id" title="notation">⊤</span> <span class="id" title="notation">}}</span>)%<span class="id" title="var">I</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">secret</span> <span class="id" title="var">e_closure</span> ; <span class="id" title="tactic">subst</span> <span class="id" title="var">secret</span> <span class="id" title="var">e_closure</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> (<span class="id" title="var">Hpc_perm</span> <span class="id" title="var">Hpc_bounds</span> <span class="id" title="var">Hvsecret</span> <span class="id" title="var">Hp_mem</span> <span class="id" title="var">Hrmap_dom</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"(#Hinv_prog &amp; #Hinv_mem' &amp; #Hinv_secret &amp; #Hinv_cap &amp; HPC &amp; Hr30 &amp; Hrmap &amp; Hna &amp; #Hvadv)".<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FTLR&nbsp;on&nbsp;V(w_adv)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iDestruct</span> <span class="id" title="notation">(</span><a class="idref" href="cap_machine.fundamental.html#jmp_to_unknown"><span class="id" title="axiom">jmp_to_unknown</span></a> <span class="id" title="notation">with</span> "Hvadv"<span class="id" title="notation">)</span> <span class="id" title="keyword">as</span> "Cont".<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;open&nbsp;the&nbsp;invariant&nbsp;on&nbsp;the&nbsp;shared&nbsp;buffer,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;needed&nbsp;to&nbsp;prove&nbsp;that&nbsp;r1&nbsp;is&nbsp;safe&nbsp;to&nbsp;share&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> /<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#end_mem_inv"><span class="id" title="definition">end_mem_inv</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iMod</span> <span class="id" title="notation">(</span><span class="id" title="lemma">na_inv_acc</span> <span class="id" title="notation">with</span> "Hinv_mem' Hna"<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> "(Hmem'&amp; Hna&amp; Hnainv_close)" ; <span class="id" title="tactic">auto</span>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Extract&nbsp;the&nbsp;register&nbsp;r_t1&nbsp;-&nbsp;r_t3&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iExtractList</span> "Hrmap" <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a> <span class="id" title="keyword">as</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a>"[Hr1 _]"<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> "[Hr2 _]"<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> "[Hr3 _]"<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Apply&nbsp;the&nbsp;spec&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iApply</span> <span class="id" title="notation">(</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#closure_spec"><span class="id" title="axiom">closure_spec</span></a> <span class="id" title="notation">with</span> "[-]"<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> <span class="id" title="var">iFrame</span> "HPC Hr1 Hr2 Hr3 Hr30 Hna"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> <span class="id" title="var">iFrame</span> "#"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">eauto</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> <span class="id" title="var">solve_ndisj</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iNext</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> "(HPC &amp; Hr1 &amp; Hr2 &amp; Hr3 &amp; Hr30 &amp; Hna)".<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;also&nbsp;need&nbsp;to&nbsp;prove&nbsp;that&nbsp;Hr1&nbsp;is&nbsp;safe&nbsp;to&nbsp;share&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iAssert</span> (<a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> (<a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <span class="id" title="var">p_mem</span> (<span class="id" title="var">b_mem</span> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+(</span></a><span class="id" title="var">secret_off</span><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">)</span></a>)%<span class="id" title="var">a</span> <span class="id" title="var">e_mem</span> (<span class="id" title="var">b_mem</span> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <span class="id" title="var">secret_off</span>)%<span class="id" title="var">a</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">with</span> "[Hmem']"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">as</span> "#Hinterp_r1".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">unfold</span> <a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">p_mem</span> ; <span class="id" title="tactic">try</span> <span class="id" title="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="tactic">rewrite</span> (<a class="idref" href="cap_machine.logrel.html#fixpoint_interp1_eq"><span class="id" title="lemma">fixpoint_interp1_eq</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <span class="id" title="var">_</span> (<span class="id" title="var">b_mem</span> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">(</span></a><span class="id" title="var">secret_off</span><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">)</span></a>)%<span class="id" title="var">a</span> <span class="id" title="var">e_mem</span> (<span class="id" title="var">b_mem</span> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <span class="id" title="var">secret_off</span>)%<span class="id" title="var">a</span>)) .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="var">iFrame</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> /<a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Re-insert&nbsp;the&nbsp;registers&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iCombine</span> "Hr1 Hinterp_r1" <span class="id" title="keyword">as</span> "Hr1".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iCombine</span> "Hr30 Hvadv" <span class="id" title="keyword">as</span> "Hr30".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iAssert</span> (<a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> (<a class="idref" href="cap_machine.machine_base.html#WInt"><span class="id" title="constructor">WInt</span></a> (<span class="id" title="var">b_mem</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">(</span></a><span class="id" title="var">secret_off</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a> 1<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">)</span></a>))) <span class="id" title="keyword">as</span> "Hr2i". <span class="id" title="var">iApply</span> <a class="idref" href="cap_machine.logrel.html#interp_int"><span class="id" title="lemma">interp_int</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iCombine</span> "Hr2 Hr2i" <span class="id" title="keyword">as</span> "Hr2".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iAssert</span> (<a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> (<a class="idref" href="cap_machine.machine_base.html#WInt"><span class="id" title="constructor">WInt</span></a> <span class="id" title="var">e_mem</span>)) <span class="id" title="keyword">as</span> "Hr3i". <span class="id" title="var">iApply</span> <a class="idref" href="cap_machine.logrel.html#interp_int"><span class="id" title="lemma">interp_int</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iCombine</span> "Hr3 Hr3i" <span class="id" title="keyword">as</span> "Hr3".<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;iAssert&nbsp;(interp&nbsp;vr_t1)&nbsp;as&nbsp;"Hrt1".&nbsp;auto.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iInsertList</span> "Hrmap" <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><a class="idref" href="cap_machine.addr_reg.html#r_t3"><span class="id" title="definition">r_t3</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><a class="idref" href="cap_machine.addr_reg.html#r_t2"><span class="id" title="definition">r_t2</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><a class="idref" href="cap_machine.addr_reg.html#r_t1"><span class="id" title="definition">r_t1</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Close&nbsp;the&nbsp;invariant&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iMod</span> <span class="id" title="notation">(</span>"Hnainv_close" <span class="id" title="notation">with</span> "[$Hna]"<span class="id" title="notation">)</span> <span class="id" title="keyword">as</span> "Hna".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="var">iNext</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> /<a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">p_mem</span> <span class="id" title="var">eqn</span>:<span class="id" title="var">Heq</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="tactic">rewrite</span> (<a class="idref" href="cap_machine.logrel.html#fixpoint_interp1_eq"><span class="id" title="lemma">fixpoint_interp1_eq</span></a> (<a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">e_mem</span> <span class="id" title="var">_</span>)) .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="var">iFrame</span> "#".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Apply&nbsp;the&nbsp;continuation&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iApply</span> "Cont" ; [|<span class="id" title="var">iFrame</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iPureIntro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> !<span class="id" title="lemma">dom_insert_L</span> <span class="id" title="var">Hrmap_dom</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> !<span class="id" title="lemma">singleton_union_difference_L</span>. <span class="id" title="var">set_solver</span>+.<br/>
&nbsp;&nbsp;<span class="id" title="var">Unshelve</span>. <span class="id" title="var">Fail</span> <span class="id" title="tactic">idtac</span>. <span class="id" title="var">Admitted</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;encapsulation&nbsp;of&nbsp;the&nbsp;program&nbsp;in&nbsp;a&nbsp;sentry-capability&nbsp;is&nbsp;safe&nbsp;to&nbsp;share&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a id="closure_prog_safe_to_share" class="idref" href="#closure_prog_safe_to_share"><span class="id" title="lemma">closure_prog_safe_to_share</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="b_pc:97" class="idref" href="#b_pc:97"><span class="id" title="binder">b_pc</span></a> <a id="e_pc:98" class="idref" href="#e_pc:98"><span class="id" title="binder">e_pc</span></a> <a id="a_prog:99" class="idref" href="#a_prog:99"><span class="id" title="binder">a_prog</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="p_mem:100" class="idref" href="#p_mem:100"><span class="id" title="binder">p_mem</span></a> <a id="b_mem:101" class="idref" href="#b_mem:101"><span class="id" title="binder">b_mem</span></a> <a id="e_mem:102" class="idref" href="#e_mem:102"><span class="id" title="binder">e_mem</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="secret_off:103" class="idref" href="#secret_off:103"><span class="id" title="binder">secret_off</span></a> <a id="secret_val:104" class="idref" href="#secret_val:104"><span class="id" title="binder">secret_val</span></a> :<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="machine_utils.finz_base.html#SubBounds"><span class="id" title="definition">SubBounds</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:97"><span class="id" title="variable">b_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_pc:98"><span class="id" title="variable">e_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:99"><span class="id" title="variable">a_prog</span></a> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:99"><span class="id" title="variable">a_prog</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <span class="id" title="abbreviation">length</span> (<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#closure_code"><span class="id" title="definition">closure_code</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:103"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:104"><span class="id" title="variable">secret_val</span></a>))%<span class="id" title="var">a</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:101"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.addr_reg.html#ecb49afb136c57143f8ddd1e3e9a03fe"><span class="id" title="notation">&lt;=</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:101"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.addr_reg.html#58e53c8acf01fb8822eb5bae448055ec"><span class="id" title="notation">^+</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:103"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.addr_reg.html#ecb49afb136c57143f8ddd1e3e9a03fe"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:102"><span class="id" title="variable">e_mem</span></a>)%<span class="id" title="var">a</span> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#writeAllowed"><span class="id" title="definition">writeAllowed</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:100"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a> <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">-&gt;</span></a><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">⊢</span> <span class="id" title="notation">(</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#code_closure_inv"><span class="id" title="definition">code_closure_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:99"><span class="id" title="variable">a_prog</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:103"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:104"><span class="id" title="variable">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#end_mem_inv"><span class="id" title="definition">end_mem_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:101"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:102"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:103"><span class="id" title="variable">secret_off</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_inv"><span class="id" title="definition">secret_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:101"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_off:103"><span class="id" title="variable">secret_off</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#secret_val:104"><span class="id" title="variable">secret_val</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">∗</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#cap_mem_inv"><span class="id" title="definition">cap_mem_inv</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#p_mem:100"><span class="id" title="variable">p_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_mem:101"><span class="id" title="variable">b_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_mem:102"><span class="id" title="variable">e_mem</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:97"><span class="id" title="variable">b_pc</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">)</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">-∗</span> <a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> (<a class="idref" href="cap_machine.machine_base.html#WCap"><span class="id" title="abbreviation">WCap</span></a> <a class="idref" href="cap_machine.machine_base.html#E"><span class="id" title="constructor">E</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#b_pc:97"><span class="id" title="variable">b_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#e_pc:98"><span class="id" title="variable">e_pc</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#a_prog:99"><span class="id" title="variable">a_prog</span></a>).<br/>
&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> (<span class="id" title="var">Hbounds</span> <span class="id" title="var">Hb_mem</span> <span class="id" title="var">Hp_mem</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"(#Hnainv_code &amp; #Hinv_mem' &amp; #Hinv_secret &amp; #Hinv_cap)".<br/>
&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;1&nbsp;-&nbsp;unfold&nbsp;the&nbsp;definitions&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> !<a class="idref" href="cap_machine.logrel.html#fixpoint_interp1_eq"><span class="id" title="lemma">fixpoint_interp1_eq</span></a> /=.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> (<span class="id" title="var">regs</span>).<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">iNext</span>; <span class="id" title="var">iModIntro</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> "(Hrsafe&amp; Hregs&amp; Hna)".<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">iDestruct</span> "Hrsafe" <span class="id" title="keyword">as</span> "[%Hrfull #Hrsafe]".<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> /<a class="idref" href="cap_machine.logrel.html#interp_conf"><span class="id" title="definition">interp_conf</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> {1}/<a class="idref" href="cap_machine.logrel.html#registers_mapsto"><span class="id" title="definition">registers_mapsto</span></a>.<br/>

<br/>
&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;2&nbsp;-&nbsp;prepare&nbsp;the&nbsp;registers&nbsp;for&nbsp;closure_full_run_spec&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <a class="idref" href="cap_machine.addr_reg.html#regmap_full_dom"><span class="id" title="axiom">regmap_full_dom</span></a> <span class="id" title="tactic">in</span> <span class="id" title="var">Hrfull</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="definition">is_Some</span> (<span class="id" title="var">regs</span> <span class="id" title="notation">!!</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a>)) <span class="id" title="keyword">as</span> [<span class="id" title="var">w30</span> <span class="id" title="var">Hw30</span>];[<span class="id" title="tactic">rewrite</span> -<span class="id" title="method">elem_of_dom</span> <span class="id" title="var">Hrfull</span>; <span class="id" title="var">set_solver</span>|].<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">iExtractList</span> "Hregs" <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a><a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a><a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a> <span class="id" title="keyword">as</span>  <a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a>"HPC"<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> "Hw30"<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">iAssert</span> (<a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> <span class="id" title="var">w30</span>) <span class="id" title="keyword">as</span> "Hw30i".<br/>
&nbsp;&nbsp;&nbsp;{ <span class="id" title="var">iApply</span> <span class="id" title="notation">(</span>"Hrsafe" <span class="id" title="notation">$!</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a> <span class="id" title="var">w30</span><span class="id" title="notation">)</span> ; <span class="id" title="tactic">eauto</span>. }<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">set</span> (<span class="id" title="var">rmap</span>:= <span class="id" title="definition">delete</span> <a class="idref" href="cap_machine.addr_reg.html#r_t30"><span class="id" title="definition">r_t30</span></a> (<span class="id" title="definition">delete</span> <a class="idref" href="cap_machine.addr_reg.html#PC"><span class="id" title="constructor">PC</span></a> <span class="id" title="var">regs</span>)).<br/>

<br/>
&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;3&nbsp;-&nbsp;use&nbsp;the&nbsp;full&nbsp;specification&nbsp;to&nbsp;show&nbsp;that&nbsp;the&nbsp;program&nbsp;executes&nbsp;safely&nbsp;and&nbsp;completely&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">iApply</span> <span class="id" title="notation">(</span><a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#closure_full_run_spec"><span class="id" title="axiom">closure_full_run_spec</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="cap_machine.machine_base.html#RX"><span class="id" title="constructor">RX</span></a> <span class="id" title="var">b_pc</span> <span class="id" title="var">e_pc</span> <span class="id" title="var">a_prog</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">p_mem</span> <span class="id" title="var">b_mem</span> <span class="id" title="var">e_mem</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">secret_off</span> <span class="id" title="var">secret_val</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">rmap</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">with</span> "[-]"<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">eauto</span><br/>
&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> <span class="id" title="tactic">apply</span> <a class="idref" href="cap_machine.machine_base.html#ExecPCPerm_RX"><span class="id" title="lemma">ExecPCPerm_RX</span></a><br/>
&nbsp;&nbsp;&nbsp;; <span class="id" title="tactic">try</span> (<span class="id" title="var">iFrame</span> ; <span class="id" title="var">iFrame</span> "#").<br/>
&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">subst</span> <span class="id" title="var">rmap</span>. <span class="id" title="var">solve_map_dom</span>.<br/>
&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">subst</span> <span class="id" title="var">rmap</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iDestruct</span> <span class="id" title="notation">(</span><span class="id" title="lemma">big_sepM_sep</span> <span class="id" title="var">_</span> (<a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Unicode.Utf8_core.html#bc1ad27deabe143d39d35abe6be2c1a4"><span class="id" title="notation">λ</span></a> <a id="k:105" class="idref" href="#k:105"><span class="id" title="binder"><span id="k:107" class="id">k</span></span></a> <a id="v:106" class="idref" href="#v:106"><span class="id" title="binder"><span id="v:108" class="id">v</span></span></a><a class="idref" href="http://coq.inria.fr/distrib/V8.18.0/stdlib//Coq.Unicode.Utf8_core.html#bc1ad27deabe143d39d35abe6be2c1a4"><span class="id" title="notation">,</span></a> <a class="idref" href="cap_machine.logrel.html#interp"><span class="id" title="definition">interp</span></a> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#v:106"><span class="id" title="variable">v</span></a>)%<span class="id" title="var">I</span> <span class="id" title="notation">with</span> "[Hregs]"<span class="id" title="notation">)</span> <span class="id" title="keyword">as</span> "Hregs".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="var">iSplitL</span>. <span class="id" title="tactic">by</span> <span class="id" title="var">iApply</span> "Hregs". <span class="id" title="var">iApply</span> <span class="id" title="lemma">big_sepM_intro</span>. <span class="id" title="var">iModIntro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iIntros</span> (<span class="id" title="var">r'</span> ? <span class="id" title="var">HH</span>). <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">eapply</span> <span class="id" title="lemma">lookup_delete_Some</span> <span class="id" title="tactic">in</span> <span class="id" title="var">HH</span> <span class="id" title="keyword">as</span> [? <span class="id" title="var">HH</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iApply</span> <span class="id" title="notation">(</span>"Hrsafe" <span class="id" title="notation">$!</span> <span class="id" title="var">r'</span><span class="id" title="notation">)</span>; <span class="id" title="tactic">auto</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">iFrame</span>.<br/>
&nbsp;<span class="id" title="var">Unshelve</span>. <span class="id" title="var">Fail</span> <span class="id" title="tactic">idtac</span>. <span class="id" title="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
Adequacy theorem - the template of the adequacy theorem defined in Cerise
    requires the memory invariant being in the memory of the program.
    However, the memory buffer is not inside the memory closure of the program.
    Therefore, we cannot apply the adequacy theorem on this instance. 
<div class="paragraph"> </div>

 Remarks : We could apply the adequacy theorem on this instance,
               but not using the template defined in Cerise. We could
               use the adequacy theorem of Cerise, but it is out-of-scope
               here 
</div>
<div class="code">
<span class="id" title="keyword">End</span> <a class="idref" href="cap_machine.exercises.subseg_buffer_closure.html#closure_program"><span class="id" title="section">closure_program</span></a>.<br/>
</div>
</div>
<div id="footer">
  Generated by <a href="http://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a>
</div>
</div>
</body>

</html>
